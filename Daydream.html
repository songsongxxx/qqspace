<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Daydream Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Press Start 2P', monospace;
            background-color: #f5f5f5;
            color: #333;
            display: flex;
            flex-direction: row;
            height: 100vh;
        }

        .poem-section {
            flex: 2;
            padding: 40px;
            overflow-y: auto;
            background: #fff;
        }

        .typing-container {
            font-size: 14px;
            line-height: 1.8;
            white-space: pre-line;
        }

        .chat-sidebar {
            flex: 1;
            background-color: #ecf2f7;
            border-right: 3px solid #888;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .chat-sidebar h2 {
            font-size: 16px;
            margin-bottom: 20px;
        }

        .friend {
            background-color: #fff;
            border: 2px solid #444;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 2px 2px 0 #888;
        }

        .add-button {
            margin-top: auto;
            padding: 10px;
            border: 2px dashed #444;
            text-align: center;
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border: 3px solid #444;
            padding: 20px;
            z-index: 100;
            box-shadow: 4px 4px 0 #888;
            text-align: center;
        }

        .modal input[type="text"] {
            width: 80%;
            margin: 10px 0;
        }

        .modal-buttons button {
            margin: 10px;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 99;
        }
    </style>
</head>

<body>
    <div class="chat-sidebar">
        <h2>Friends Online</h2>
        <div id="friendList"></div>
        <div class="add-button" onclick="openModal()">+ Add Friend</div>
    </div>

    <div class="poem-section">
        <h1>Daydream</h1>
        <div class="typing-container" id="typewriter"></div><span class="cursor">|</span>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="modal" id="modal">
        <h3>Add a Friend</h3>
        <input type="text" id="nameInput" placeholder="Name"><br>
        <div class="modal-buttons">
            <button onclick="addFriend()">Add</button>
            <button onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <script>
        const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbxkDUFis5vO8xGIK9NtXptAFyIL1GGCz3j835qB03wNMJhI_I21X-ckPx6rKNe6UHs3Bw/exec';

        // 打字机效果
        const text = Daydream\n\nThose \"overly sentimental\" moments,\nThose \"insignificant\" fragments of time.\nI am an emotional trash bin,\nCollecting only the daydreams that are not allowed.\n\nIn an era of maximum output,\nMy fantasies have become noise,\nAnd my body, a miscalculation.\n\nI just want to—\nJust quietly—\nFeel my body,\nFeel the blurred waves inside me,\nFeel the immeasurable touches between myself and the surroundings.\n\nI am a wasteland,\nPiled high with daydreams.;
        let i = 0;
        const speed = 40;
        const typewriter = document.getElementById("typewriter");

        function typeText() {
            if (i < text.length) {
                typewriter.textContent += text.charAt(i);
                i++;
                setTimeout(typeText, speed);
            }
        }
        typeText();

        // 弹窗控制
        function openModal() {
            console.log("🔍 openModal called");
            document.getElementById('modal').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        // 添加好友
        function addFriend() {
            const name = document.getElementById('nameInput').value;
            if (!name) return;

            fetch(SHEET_API_URL, {
                method: 'POST',
                body: JSON.stringify({ name }),
                headers: { 'Content-Type': 'application/json' }
            }).then(() => {
                closeModal();
                alert('Name submitted! Please refresh later to see it.');
            }).catch(err => {
                console.error("🚨 Submission failed", err);
                alert("Error submitting friend.");
            });
        }

        // 加载好友列表
        fetch(SHEET_API_URL)
            .then(res => res.json())
            .then(data => {
                const container = document.getElementById('friendList');
                container.innerHTML = '';
                data.forEach(friend => {
                    const friendHTML = <div class='friend'><span>${friend.name}</span></div>;
                    container.insertAdjacentHTML('beforeend', friendHTML);
                });
            }).catch(err => {
                console.error("🚨 Load failed", err);
            });
    </script>
</body>

</html>